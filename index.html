<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatto - WA Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS ALA WHATSAPP WEB */
        :root {
            --wa-header: #00a884;
            --wa-bg: #efeae2;
            --wa-sidebar: #ffffff;
            --wa-sent: #d9fdd3;
            --wa-received: #ffffff;
            --wa-dark: #111b21;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: #d1d7db;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Container Utama */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Sidebar Kiri */
        .sidebar {
            width: 30%;
            border-right: 1px solid #e9edef;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .sidebar-header {
            background: #f0f2f5;
            padding: 10px 16px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-right: 1px solid #d1d7db;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
        }

        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; }

        .avatar {
            width: 45px;
            height: 45px;
            background: #dfe5e7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: gray;
        }

        /* Area Chat Kanan */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--wa-bg);
            /* Pattern Background WA */
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
            position: relative;
        }

        .chat-header {
            background: #f0f2f5;
            height: 60px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            border-left: 1px solid #d1d7db;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Bubble Chat */
        .message {
            max-width: 60%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--wa-sent);
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--wa-received);
        }

        .meta-info {
            font-size: 10px;
            color: #667781;
            text-align: right;
            margin-top: 4px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
        }

        /* Input Area */
        .input-area {
            height: 62px;
            background: #f0f2f5;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-box {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            outline: none;
            background: white;
        }

        .btn-send {
            background: none;
            border: none;
            color: #54656f;
            cursor: pointer;
            font-size: 20px;
        }

        /* Login Modal Sederhana */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px; text-align: center;
            width: 300px;
        }
        .login-box input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd;
        }
        .login-box button {
            background: var(--wa-header); color: white; border: none;
            padding: 10px 20px; cursor: pointer; border-radius: 5px; width: 100%;
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .app-container { width: 100%; height: 100vh; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h3>Masuk Chatto</h3>
            <p>Masukkan Nama Panggilan</p>
            <input type="text" id="usernameInput" placeholder="Nama kamu...">
            <button onclick="loginUser()">MASUK</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div style="flex:1; margin-left:10px; font-weight:bold;" id="myDisplayName">User</div>
            </div>
            <div class="chat-list">
                <div class="chat-item active">
                    <div class="avatar"><i class="fas fa-users"></i></div>
                    <div>
                        <div style="font-weight: 500;">Grup Warga GitHub</div>
                        <div style="font-size: 12px; color: grey;">Klik untuk mulai chat...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="avatar"><i class="fas fa-users"></i></div>
                <div style="margin-left: 15px;">
                    <div style="font-weight: bold;">Grup Warga GitHub</div>
                    <div style="font-size: 12px; color: grey;">Online</div>
                </div>
            </div>

            <div class="messages-container" id="messagesList">
                </div>

            <div class="input-area">
                <i class="far fa-smile btn-send"></i>
                <i class="fas fa-plus btn-send"></i>
                <input type="text" class="input-box" id="msgInput" placeholder="Ketik pesan">
                <button class="btn-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // 1. CONFIG FIREBASE (PUNYA AGAN SUDAH SAYA MASUKKAN DISINI)
        const firebaseConfig = {
            apiKey: "AIzaSyBH9Udej6I9JankuJS9J57KPzn8DNUlNYA",
            authDomain: "chatto-82194.firebaseapp.com",
            projectId: "chatto-82194",
            storageBucket: "chatto-82194.firebasestorage.app",
            messagingSenderId: "169590873334",
            appId: "1:169590873334:web:3a8d4581b10aa88096a0d7"
        };

        // 2. INISIALISASI DATABASE
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            // Mencegah error duplikasi inisialisasi
        } catch (e) {
            console.error("Firebase init error", e);
        }
        
        const db = firebase.firestore();
        let currentUser = "";

        // LOGIN
        function loginUser() {
            const name = document.getElementById('usernameInput').value;
            if(name.trim() !== "") {
                currentUser = name;
                document.getElementById('myDisplayName').innerText = currentUser;
                document.getElementById('loginOverlay').style.display = 'none';
                loadMessages();
            } else {
                alert("Isi nama dulu bos!");
            }
        }

        // LOAD PESAN
        function loadMessages() {
            db.collection("chats").orderBy("timestamp", "asc")
                .onSnapshot((snapshot) => {
                    const chatList = document.getElementById("messagesList");
                    chatList.innerHTML = ""; 
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const isMe = data.user === currentUser;
                        
                        // FIX: Cek timestamp biar ga error "Invalid Date"
                        let timeString = "...";
                        if (data.timestamp) {
                            timeString = new Date(data.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }

                        const bubble = `
                            <div class="message ${isMe ? 'sent' : 'received'}">
                                ${!isMe ? `<div style="font-weight:bold; color: #d64646; font-size:12px; margin-bottom:2px;">${data.user}</div>` : ''}
                                ${data.text}
                                <div class="meta-info">
                                    ${timeString}
                                    ${isMe ? '<i class="fas fa-check-double" style="color: #53bdeb;"></i>' : ''}
                                </div>
                            </div>
                        `;
                        chatList.innerHTML += bubble;
                    });

                    // Auto scroll ke bawah
                    chatList.scrollTop = chatList.scrollHeight;
                });
        }

        // KIRIM PESAN
        function sendMessage() {
            const input = document.getElementById("msgInput");
            const text = input.value;

            if (text.trim() !== "") {
                db.collection("chats").add({
                    text: text,
                    user: currentUser,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch((error) => {
                    console.error("Error sending message: ", error);
                    alert("Gagal kirim pesan. Cek koneksi atau setting database.");
                });
                input.value = ""; 
            }
        }

        // Enter untuk kirim
        document.getElementById("msgInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
